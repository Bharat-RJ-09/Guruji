<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password | NextEdu</title>
    <link rel="stylesheet" href="assets/css/auth.css">
</head>
<body>
    <div class="glow-bg"></div>

    <div class="auth-card">
        <h2>Reset Password</h2>
        <p>Enter the code sent to your Telegram.</p>

        <div id="msgBox" class="message-box"></div>

        <form id="resetForm">
            <input type="hidden" id="username_hidden">

            <div class="input-group">
                <label>OTP Code</label>
                <input type="text" id="otp_code" required placeholder="e.g. 123456" maxlength="6">
            </div>

            <div class="input-group">
                <label>New Password</label>
                <input type="password" id="new_pass" required minlength="4">
            </div>

            <button type="submit" class="btn-primary" id="submitBtn">Update Password</button>
        </form>
    </div>

    <script>
        // 1. Auto-fill Username from URL (passed from forgot-password.html)
        const urlParams = new URLSearchParams(window.location.search);
        const userParam = urlParams.get('user');
        if(userParam) {
            document.getElementById('username_hidden').value = userParam;
        } else {
            alert("Invalid Access. Please go back to Forgot Password page.");
            window.location.href = "forgot-password.html";
        }

        // 2. Handle Submission
        document.getElementById('resetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('msgBox');
            
            const data = {
                username: document.getElementById('username_hidden').value,
                otp: document.getElementById('otp_code').value,
                new_password: document.getElementById('new_pass').value
            };

            btn.disabled = true;
            btn.innerText = "Updating...";

            try {
                const res = await fetch('api/auth/reset_pass.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if(result.status === 'success') {
                    msg.className = "message-box success";
                    msg.innerText = "✅ " + result.message;
                    msg.style.display = "block";
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } else {
                    msg.className = "message-box error";
                    msg.innerText = "❌ " + result.message;
                    msg.style.display = "block";
                    btn.disabled = false;
                    btn.innerText = "Update Password";
                }
            } catch(e) { 
                console.error(e);
                alert("Server Error");
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>